<!-- Adapted from Mike Bostockâ€™s Block 1093025 @ https://bl.ocks.org/mbostock/1093025 -->
<!-- Released under the GNU General Public License, version 3. -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title id="title"></title>
<style>
.node rect {
  cursor: pointer;
  fill: #fff;
  fill-opacity: 0.8;
  stroke: #000;
  stroke-width: 1px;
}
#legend rect {
	fill-opacity: 0.8;
	stroke: #000;
    stroke-width: 1px;
}
.node text {
  font: 10px sans-serif;
  pointer-events: none;
}
path.link {
  fill: none;
  stroke: #000;
  stroke-width: 1px;
}
</style>
<body>
<script id="data" type="text/json">
{"name": "history", "children": [{"href": "/home/thomas/git/e3/e3_data/lucid_einstein/index.html", "type": "tap", "name": "lucid_einstein", "children": [{"endTime": "03/02/2017 23:26:37", "name": "reset", "startTime": "03/02/2017 23:26:36", "runTime": "0.37 sec.", "type": "modelCommand", "children": []}]}, {"href": "/home/thomas/git/e3/e3_data/empty_tap/index.html", "type": "tap", "name": "empty_tap", "children": [{"endTime": "03/02/2017 23:26:40", "name": "use tap demo_abstract", "startTime": "03/02/2017 23:26:40", "runTime": "0.03 sec.", "type": "modelCommand", "children": []}]}, {"href": "/home/thomas/git/e3/e3_data/demo_abstract/index.html", "type": "tap", "name": "demo_abstract", "children": [{"endTime": "03/02/2017 23:26:43", "name": "remove articulation 1", "startTime": "03/02/2017 23:26:42", "runTime": "0.05 sec.", "type": "modelCommand", "children": []}]}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/index.html", "type": "tap", "name": "happy_payne", "children": [{"endTime": "03/02/2017 23:26:45", "name": "is consistent", "startTime": "03/02/2017 23:26:44", "runTime": "0.12 sec.", "type": "euler2Command", "children": [{"type": "commandOutput", "name": "yes", "children": []}]}, {"endTime": "03/02/2017 23:26:49", "name": "graph worlds", "startTime": "03/02/2017 23:26:47", "runTime": "2.79 sec.", "type": "euler2Command", "children": [{"type": "commandOutput", "name": "There are 22 possible worlds. I will only show 5 of them to you.", "children": [{"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_worlds/graph_worlds_21_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_21_mnpw.svg", "children": []}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_worlds/graph_worlds_12_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_12_mnpw.svg", "children": []}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_worlds/graph_worlds_9_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_9_mnpw.svg", "children": []}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_worlds/config.txt", "type": "commandOutputFile", "name": "config.txt", "children": []}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_worlds/graph_worlds_19_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_19_mnpw.svg", "children": []}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_worlds/graph_worlds_13_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_13_mnpw.svg", "children": []}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_worlds/graph_worlds_7_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_7_mnpw.svg", "children": []}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_worlds/graph_worlds_15_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_15_mnpw.svg", "children": []}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_worlds/index.html", "type": "commandOutputFile", "name": "index.html", "children": []}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_worlds/graph_worlds_14_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_14_mnpw.svg", "children": []}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_worlds/graph_worlds_2_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_2_mnpw.svg", "children": []}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_worlds/graph_worlds_0_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_0_mnpw.svg", "children": []}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_worlds/graph_worlds_16_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_16_mnpw.svg", "children": []}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_worlds/graph_worlds_8_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_8_mnpw.svg", "children": []}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_worlds/graph_worlds_17_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_17_mnpw.svg", "children": []}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_worlds/graph_worlds_6_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_6_mnpw.svg", "children": []}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_worlds/graph_worlds_10_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_10_mnpw.svg", "children": []}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_worlds/graph_worlds_20_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_20_mnpw.svg", "children": []}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_worlds/graph_worlds_1_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_1_mnpw.svg", "children": []}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_worlds/graph_worlds_5_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_5_mnpw.svg", "children": []}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_worlds/graph_worlds_18_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_18_mnpw.svg", "children": []}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_worlds/graph_worlds_3_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_3_mnpw.svg", "children": []}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_worlds/graph_worlds_4_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_4_mnpw.svg", "children": []}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_worlds/graph_worlds_11_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_11_mnpw.svg", "children": []}]}]}, {"endTime": "03/02/2017 23:26:55", "name": "graph tap", "startTime": "03/02/2017 23:26:55", "runTime": "0.0 sec.", "type": "euler2Command", "children": [{"type": "commandOutput", "name": "Take a look at the graph", "children": [{"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_tap/config.txt", "type": "commandOutputFile", "name": "config.txt", "children": []}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_tap/index.html", "type": "commandOutputFile", "name": "index.html", "children": []}, {"href": "/home/thomas/git/e3/e3_data/happy_payne/graph_tap/graph_tap.svg", "type": "commandOutputFile", "name": "graph_tap.svg", "children": []}]}]}, {"endTime": "03/02/2017 23:26:59", "name": "use tap demo_oaks", "startTime": "03/02/2017 23:26:58", "runTime": "0.04 sec.", "type": "modelCommand", "children": []}]}, {"href": "/home/thomas/git/e3/e3_data/demo_oaks/index.html", "type": "tap", "name": "demo_oaks", "children": [{"endTime": "03/02/2017 23:27:01", "name": "is consistent", "startTime": "03/02/2017 23:27:01", "runTime": "0.16 sec.", "type": "euler2Command", "children": [{"type": "commandOutput", "name": "yes", "children": []}]}, {"endTime": "03/02/2017 23:27:04", "name": "more than 2 worlds", "startTime": "03/02/2017 23:27:03", "runTime": "0.18 sec.", "type": "euler2Command", "children": [{"type": "commandOutput", "name": "There are less than or equal to 2 possible worlds. There are 1.", "children": []}]}, {"endTime": "03/02/2017 23:27:09", "name": "graph worlds", "startTime": "03/02/2017 23:27:08", "runTime": "0.32 sec.", "type": "euler2Command", "children": [{"type": "commandOutput", "name": "There are 1 possible worlds. I show them all to you.", "children": [{"href": "/home/thomas/git/e3/e3_data/demo_oaks/graph_worlds/config.txt", "type": "commandOutputFile", "name": "config.txt", "children": []}, {"href": "/home/thomas/git/e3/e3_data/demo_oaks/graph_worlds/index.html", "type": "commandOutputFile", "name": "index.html", "children": []}, {"href": "/home/thomas/git/e3/e3_data/demo_oaks/graph_worlds/graph_worlds.svg", "type": "commandOutputFile", "name": "graph_worlds.svg", "children": []}]}]}, {"endTime": "03/02/2017 23:27:12", "name": "remove articulation 1", "startTime": "03/02/2017 23:27:12", "runTime": "0.06 sec.", "type": "modelCommand", "children": []}]}, {"href": "/home/thomas/git/e3/e3_data/lucid_einstein/index.html", "type": "tap", "name": "lucid_einstein", "children": [{"endTime": "03/02/2017 23:27:14", "name": "is consistent", "startTime": "03/02/2017 23:27:14", "runTime": "0.16 sec.", "type": "euler2Command", "children": [{"type": "commandOutput", "name": "yes", "children": []}]}, {"endTime": "03/02/2017 23:27:19", "name": "more than 3 worlds", "startTime": "03/02/2017 23:27:18", "runTime": "0.18 sec.", "type": "euler2Command", "children": [{"type": "commandOutput", "name": "There are more than 3 possible worlds.", "children": []}]}, {"endTime": "03/02/2017 23:27:23", "name": "more than 10 worlds", "startTime": "03/02/2017 23:27:23", "runTime": "0.14 sec.", "type": "euler2Command", "children": [{"type": "commandOutput", "name": "There are less than or equal to 10 possible worlds. There are 5.", "children": []}]}, {"endTime": "03/02/2017 23:27:26", "name": "graph worlds", "startTime": "03/02/2017 23:27:26", "runTime": "0.62 sec.", "type": "euler2Command", "children": [{"type": "commandOutput", "name": "There are 5 possible worlds. I show them all to you.", "children": [{"href": "/home/thomas/git/e3/e3_data/lucid_einstein/graph_worlds/config.txt", "type": "commandOutputFile", "name": "config.txt", "children": []}, {"href": "/home/thomas/git/e3/e3_data/lucid_einstein/graph_worlds/index.html", "type": "commandOutputFile", "name": "index.html", "children": []}, {"href": "/home/thomas/git/e3/e3_data/lucid_einstein/graph_worlds/graph_worlds_2_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_2_mnpw.svg", "children": []}, {"href": "/home/thomas/git/e3/e3_data/lucid_einstein/graph_worlds/graph_worlds_0_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_0_mnpw.svg", "children": []}, {"href": "/home/thomas/git/e3/e3_data/lucid_einstein/graph_worlds/graph_worlds_1_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_1_mnpw.svg", "children": []}, {"href": "/home/thomas/git/e3/e3_data/lucid_einstein/graph_worlds/graph_worlds_3_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_3_mnpw.svg", "children": []}, {"href": "/home/thomas/git/e3/e3_data/lucid_einstein/graph_worlds/graph_worlds_4_mnpw.svg", "type": "commandOutputFile", "name": "graph_worlds_4_mnpw.svg", "children": []}]}]}]}]} 
</script>
<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script>
var margin = {top: 30, right: 20, bottom: 30, left: 20},
    width = 960 - margin.left - margin.right,
    barHeight = 20,
    barWidth = width * .6;

var colors = d3.scale.category10();
var domain = ["tap", "modelCommand", "euler2Command", "commandOutput", "commandOutputFile", "miscCommand"];
var collapse = {}
var readableDomain = {}
readableDomain["tap"] = "Tap"
readableDomain["modelCommand"] = "Tap Command"
readableDomain["euler2Command"] = "Reasoning Command"
readableDomain["commandOutput"] = "Command's Output"
readableDomain["commandOutputFile"] = "Command's Output Files"
readableDomain["miscCommand"] = "Misc. Command"
colors.domain(domain);
domain.forEach(function(x) {
	collapse[x] = "collapse";
});

var i = 0,
    duration = 400,
    root;

var tree = d3.layout.tree()
    .nodeSize([0, 20]);

var diagonal = d3.svg.diagonal()
    .projection(function(d) { return [d.y, d.x]; });

var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var root = JSON.parse(document.getElementById('data').innerHTML);
 
root.x0 = 0;
root.y0 = 0;
update(root = root);

function update(source) {

  // Compute the flattened node list. TODO use d3.layout.hierarchy.
  var nodes = tree.nodes(root);

  var height = Math.max(500, nodes.length * barHeight + margin.top + margin.bottom);

  d3.select("svg").transition()
      .duration(duration)
      .attr("height", height);

  d3.select(self.frameElement).transition()
      .duration(duration)
      .style("height", height + "px");

  // Compute the "layout".
  nodes.forEach(function(n, i) {
    n.x = i * barHeight;
  });

  // Update the nodesâ€¦
  var node = svg.selectAll("g.node")
      .data(nodes, function(d) { return d.id || (d.id = ++i); });

  var nodeEnter = node.enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
      .style("opacity", 1e-6);

  // Enter any new nodes at the parent's previous position.
  nodeEnter.append("rect")
      .attr("y", -barHeight / 2)
      .attr("height", barHeight)
      .attr("width", barWidth)
      .style("fill", function(d) { 
			if ('type' in d) {
				return colors(d.type) 
			} else {
				return "white"
			}
		})
      .on("click", toggle)
	  .on("dblclick", followLink);

  nodeEnter.append("text")
      .attr("dy", 3.5)
      .attr("dx", 5.5)
      .text(function(d) { 
			if ("startTime" in d && "endTime" in d && "runTime" in d) {
				if (d.name.length > 40) {
					return (d.name.substring(0, 40) + " ...") + " (runtime: " + d.runTime + "; start: " + d.startTime + "; end: " + d.endTime + ")";
				} else {
					return d.name + " (runtime: " + d.runTime + "; start: " + d.startTime + "; end: " + d.endTime + ")";
				}
			}
			if (d.name.length > 80) {
				return d.name.substring(0, 80) + " ..."; 
			}
			return d.name;
	  });

  // Transition nodes to their new position.
  nodeEnter.transition()
      .duration(duration)
      .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; })
      .style("opacity", 1);

  node.transition()
      .duration(duration)
      .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; })
      .style("opacity", 1)
      .select("rect")
      .style("fill", function(d) { 
	  		if ('type' in d) {
				return colors(d.type) 
			} else {
				return "white"
			}
		});

  // Transition exiting nodes to the parent's new position.
  node.exit().transition()
      .duration(duration)
      .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
      .style("opacity", 1e-6)
      .remove();

  // Update the linksâ€¦
  var link = svg.selectAll("path.link")
      .data(tree.links(nodes), function(d) { return d.target.id; });

  // Enter any new links at the parent's previous position.
  link.enter().insert("path", "g")
      .attr("class", "link")
      .attr("d", function(d) {
        var o = {x: source.x0, y: source.y0};
        return diagonal({source: o, target: o});
      })
      .transition()
      .duration(duration)
      .attr("d", diagonal);

  // Transition links to their new position.
  link.transition()
      .duration(duration)
      .attr("d", diagonal);

  // Transition exiting nodes to the parent's new position.
  link.exit().transition()
      .duration(duration)
      .attr("d", function(d) {
        var o = {x: source.x, y: source.y};
        return diagonal({source: o, target: o});
      })
      .remove();

  // Stash the old positions for transition.
  nodes.forEach(function(d) {
    d.x0 = d.x;
    d.y0 = d.y;
  });
}

// Toggle children on click.
function toggle(d) {
  if (d.children) {
    d._children = d.children;
    d.children = null;
  } else {
    d.children = d._children;
    d._children = null;
  }
  update(d);
}

function followLink(d) {
	if('href' in d) {
		//retain possible htmlpreview.github.io prefix	
		var currentHref = window.location.href;
		if(currentHref.indexOf("htmlpreview.github.io") != -1) {
			var page = currentHref.split("/").pop();
			var location = currentHref.replace(new RegExp(page + '$'), '');
			var newHref = location + d.href;
			window.location.assign(newHref, '_blank');
		} else {
			window.location.assign(d.href, '_blank');
		}
	}
}

legend = svg.append("g")
	.attr("transform", "translate(" + (width - 250) + ", 0)")
	.attr("id", "legend");
	
cellWidth = 20
gs = legend.selectAll("g")
  .data(colors.domain());
g = gs.enter()
  .append("g")
g.append("rect")
  .attr("width", cellWidth)
  .attr("height", cellWidth)
  .attr("x", function (d, i) {return 0; })
  .attr("y", function (d, i) {return i * cellWidth})
  .style("fill", function(d) { return colors(d); })
g.append("text")
  .text(function(d) { return readableDomain[d]; })
  .attr("x", function (d, i) { return cellWidth + 5; })
  .attr("y", function (d, i) { return i * cellWidth + 15; });
 g.append("text")
  .attr("id", function(x) { return "collapse-" + x; })
  .text(function(d) { return "collapse" })
  .attr("x", function (d, i) { return cellWidth + 180; })
  .attr("y", function (d, i) { return i * cellWidth + 15; })
  .on("click", clickCollapse);
 
function clickCollapse(d) {
	currentValue = collapse[d];
	var nodes = tree.nodes(root);
	if(currentValue == "collapse") {
		nodes.forEach(function(x) {
			if(x.type == d) {
				toggle(x);
			}
		});
		collapse[d] = "expand";
		g.selectAll("#collapse-" + d)
			.text("expand");
	} else {
		nodes.forEach(function(x) {
			if(x.type == d) {
				toggle(x);
			}
		});
		g.selectAll("#collapse-" + d)
			.text("collapse");
		collapse[d] = "collapse";
	}
}
</script>
</body>
</html>
